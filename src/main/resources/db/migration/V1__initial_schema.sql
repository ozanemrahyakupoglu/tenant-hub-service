-- =============================================================
-- TenantHub Initial Schema
-- =============================================================
-- =============================================================
-- TenantHub Initial Schema - ROLLBACK
-- =============================================================

-- ---------------------------------------------------------------
-- ROLE_PERMISSION ROLLBACK
-- ---------------------------------------------------------------
DROP TRIGGER IF EXISTS TRG_ROLE_PERMISSION_HIS ON devuser.ROLE_PERMISSION;
DROP FUNCTION IF EXISTS devuser.FN_ROLE_PERMISSION_HIS();
DROP INDEX IF EXISTS devuser.IDX_ROLE_PERMISSION_HIS_ORIGINAL_ID;
DROP TABLE IF EXISTS devuser.ROLE_PERMISSION_HIS;
DROP SEQUENCE IF EXISTS devuser.SEQ_ROLE_PERMISSION_HIS;
DROP INDEX IF EXISTS devuser.IDX_ROLE_PERMISSION_ROLE_ID;
DROP INDEX IF EXISTS devuser.IDX_ROLE_PERMISSION_PERMISSION_ID;
DROP TABLE IF EXISTS devuser.ROLE_PERMISSION;
DROP SEQUENCE IF EXISTS devuser.SEQ_ROLE_PERMISSION;

-- ---------------------------------------------------------------
-- USERS_ROLE ROLLBACK
-- ---------------------------------------------------------------
DROP TRIGGER IF EXISTS TRG_USERS_ROLE_HIS ON devuser.USERS_ROLE;
DROP FUNCTION IF EXISTS devuser.FN_USERS_ROLE_HIS();
DROP INDEX IF EXISTS devuser.IDX_USERS_ROLE_HIS_ORIGINAL_ID;
DROP TABLE IF EXISTS devuser.USERS_ROLE_HIS;
DROP SEQUENCE IF EXISTS devuser.SEQ_USERS_ROLE_HIS;
DROP INDEX IF EXISTS devuser.IDX_USERS_ROLE_USERS_ID;
DROP INDEX IF EXISTS devuser.IDX_USERS_ROLE_ROLE_ID;
DROP TABLE IF EXISTS devuser.USERS_ROLE;
DROP SEQUENCE IF EXISTS devuser.SEQ_USERS_ROLE;

-- ---------------------------------------------------------------
-- PERMISSION ROLLBACK
-- ---------------------------------------------------------------
DROP TRIGGER IF EXISTS TRG_PERMISSION_HIS ON devuser.PERMISSION;
DROP FUNCTION IF EXISTS devuser.FN_PERMISSION_HIS();
DROP INDEX IF EXISTS devuser.IDX_PERMISSION_HIS_ORIGINAL_ID;
DROP TABLE IF EXISTS devuser.PERMISSION_HIS;
DROP SEQUENCE IF EXISTS devuser.SEQ_PERMISSION_HIS;
DROP INDEX IF EXISTS devuser.IDX_PERMISSION_NAME;
DROP INDEX IF EXISTS devuser.IDX_PERMISSION_MODULE;
DROP INDEX IF EXISTS devuser.IDX_PERMISSION_ACTION;
DROP INDEX IF EXISTS devuser.IDX_PERMISSION_STATUS;
DROP TABLE IF EXISTS devuser.PERMISSION;
DROP SEQUENCE IF EXISTS devuser.SEQ_PERMISSION;

-- ---------------------------------------------------------------
-- ROLE ROLLBACK
-- ---------------------------------------------------------------
DROP TRIGGER IF EXISTS TRG_ROLE_HIS ON devuser.ROLE;
DROP FUNCTION IF EXISTS devuser.FN_ROLE_HIS();
DROP INDEX IF EXISTS devuser.IDX_ROLE_HIS_ORIGINAL_ID;
DROP TABLE IF EXISTS devuser.ROLE_HIS;
DROP SEQUENCE IF EXISTS devuser.SEQ_ROLE_HIS;
DROP INDEX IF EXISTS devuser.IDX_ROLE_NAME;
DROP INDEX IF EXISTS devuser.IDX_ROLE_STATUS;
DROP TABLE IF EXISTS devuser.ROLE;
DROP SEQUENCE IF EXISTS devuser.SEQ_ROLE;

-- ---------------------------------------------------------------
-- USERS ROLLBACK
-- ---------------------------------------------------------------
DROP TRIGGER IF EXISTS TRG_USERS_HIS ON devuser.USERS;
DROP FUNCTION IF EXISTS devuser.FN_USERS_HIS();
DROP INDEX IF EXISTS devuser.IDX_USERS_HIS_ORIGINAL_ID;
DROP TABLE IF EXISTS devuser.USERS_HIS;
DROP SEQUENCE IF EXISTS devuser.SEQ_USERS_HIS;
DROP INDEX IF EXISTS devuser.IDX_USERS_USERNAME;
DROP INDEX IF EXISTS devuser.IDX_USERS_EMAIL;
DROP INDEX IF EXISTS devuser.IDX_USERS_STATUS;
DROP TABLE IF EXISTS devuser.USERS;
DROP SEQUENCE IF EXISTS devuser.SEQ_USERS;

-- ---------------------------------------------------------------
-- SCHEMA
-- ---------------------------------------------------------------
CREATE SCHEMA IF NOT EXISTS devuser;

-- ---------------------------------------------------------------
-- USERS
-- ---------------------------------------------------------------
CREATE SEQUENCE devuser.SEQ_USERS START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.USERS (
    ID                  BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_USERS'),
    USERNAME            VARCHAR(100)    NOT NULL,
    EMAIL               VARCHAR(150)    NOT NULL,
    PASSWORD_HASH       VARCHAR(255)    NOT NULL,
    FIRST_NAME          VARCHAR(100)    NOT NULL,
    LAST_NAME           VARCHAR(100)    NOT NULL,
    PHONE               VARCHAR(20),
    STATUS              VARCHAR(20)     NOT NULL DEFAULT 'ACTIVE',
    LAST_LOGIN_DATE     TIMESTAMP,
    ERROR_LOGIN_COUNT   INTEGER         NOT NULL DEFAULT 0,
    CREATED_BY          VARCHAR(100)    NOT NULL,
    CREATED_DATE        TIMESTAMP       NOT NULL,
    CREATED_IP          VARCHAR(45)     NOT NULL,
    UPDATED_BY          VARCHAR(100),
    UPDATED_DATE        TIMESTAMP,
    UPDATED_IP          VARCHAR(45),
    CONSTRAINT PK_USERS          PRIMARY KEY (ID),
    CONSTRAINT UK_USERS_USERNAME UNIQUE (USERNAME),
    CONSTRAINT UK_USERS_EMAIL    UNIQUE (EMAIL),
    CONSTRAINT CK_USERS_STATUS   CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'BLOCKED'))
);

CREATE INDEX IDX_USERS_USERNAME ON devuser.USERS (USERNAME);
CREATE INDEX IDX_USERS_EMAIL    ON devuser.USERS (EMAIL);
CREATE INDEX IDX_USERS_STATUS   ON devuser.USERS (STATUS);

CREATE SEQUENCE devuser.SEQ_USERS_HIS START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.USERS_HIS (
    ID                  BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_USERS_HIS'),
    ORIGINAL_ID         BIGINT          NOT NULL,
    USERNAME            VARCHAR(100)    NOT NULL,
    EMAIL               VARCHAR(150)    NOT NULL,
    PASSWORD_HASH       VARCHAR(255)    NOT NULL,
    FIRST_NAME          VARCHAR(100)    NOT NULL,
    LAST_NAME           VARCHAR(100)    NOT NULL,
    PHONE               VARCHAR(20),
    STATUS              VARCHAR(20)     NOT NULL,
    LAST_LOGIN_DATE     TIMESTAMP,
    ERROR_LOGIN_COUNT   INTEGER         NOT NULL,
    CREATED_BY          VARCHAR(100)    NOT NULL,
    CREATED_DATE        TIMESTAMP       NOT NULL,
    CREATED_IP          VARCHAR(45)     NOT NULL,
    UPDATED_BY          VARCHAR(100),
    UPDATED_DATE        TIMESTAMP,
    UPDATED_IP          VARCHAR(45),
    DML_OPERATION       VARCHAR(10),
    DML_BY              VARCHAR(100),
    DML_DATE            TIMESTAMP,
    DML_IP              VARCHAR(45),
    CONSTRAINT PK_USERS_HIS PRIMARY KEY (ID)
);

CREATE INDEX IDX_USERS_HIS_ORIGINAL_ID ON devuser.USERS_HIS (ORIGINAL_ID);

CREATE OR REPLACE FUNCTION devuser.FN_USERS_HIS()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO devuser.USERS_HIS (
            ID, ORIGINAL_ID, USERNAME, EMAIL, PASSWORD_HASH, FIRST_NAME, LAST_NAME,
            PHONE, STATUS, LAST_LOGIN_DATE, ERROR_LOGIN_COUNT,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_USERS_HIS'), NEW.ID, NEW.USERNAME, NEW.EMAIL, NEW.PASSWORD_HASH, NEW.FIRST_NAME, NEW.LAST_NAME,
            NEW.PHONE, NEW.STATUS, NEW.LAST_LOGIN_DATE, NEW.ERROR_LOGIN_COUNT,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'INSERT', NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO devuser.USERS_HIS (
            ID, ORIGINAL_ID, USERNAME, EMAIL, PASSWORD_HASH, FIRST_NAME, LAST_NAME,
            PHONE, STATUS, LAST_LOGIN_DATE, ERROR_LOGIN_COUNT,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_USERS_HIS'), NEW.ID, NEW.USERNAME, NEW.EMAIL, NEW.PASSWORD_HASH, NEW.FIRST_NAME, NEW.LAST_NAME,
            NEW.PHONE, NEW.STATUS, NEW.LAST_LOGIN_DATE, NEW.ERROR_LOGIN_COUNT,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'UPDATE', NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        INSERT INTO devuser.USERS_HIS (
            ID, ORIGINAL_ID, USERNAME, EMAIL, PASSWORD_HASH, FIRST_NAME, LAST_NAME,
            PHONE, STATUS, LAST_LOGIN_DATE, ERROR_LOGIN_COUNT,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_USERS_HIS'), OLD.ID, OLD.USERNAME, OLD.EMAIL, OLD.PASSWORD_HASH, OLD.FIRST_NAME, OLD.LAST_NAME,
            OLD.PHONE, OLD.STATUS, OLD.LAST_LOGIN_DATE, OLD.ERROR_LOGIN_COUNT,
            OLD.CREATED_BY, OLD.CREATED_DATE, OLD.CREATED_IP, OLD.UPDATED_BY, OLD.UPDATED_DATE, OLD.UPDATED_IP,
            'DELETE', COALESCE(OLD.UPDATED_BY, OLD.CREATED_BY), COALESCE(OLD.UPDATED_DATE, OLD.CREATED_DATE), COALESCE(OLD.UPDATED_IP, OLD.CREATED_IP)
        );
        RETURN OLD;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER TRG_USERS_HIS
    AFTER INSERT OR UPDATE OR DELETE ON devuser.USERS
    FOR EACH ROW EXECUTE FUNCTION devuser.FN_USERS_HIS();


-- ---------------------------------------------------------------
-- ROLE
-- ---------------------------------------------------------------
CREATE SEQUENCE devuser.SEQ_ROLE START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.ROLE (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_ROLE'),
    NAME            VARCHAR(100)    NOT NULL,
    DESCRIPTION     VARCHAR(500),
    STATUS          VARCHAR(20)     NOT NULL DEFAULT 'ACTIVE',
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    CONSTRAINT PK_ROLE        PRIMARY KEY (ID),
    CONSTRAINT UK_ROLE_NAME   UNIQUE (NAME),
    CONSTRAINT CK_ROLE_STATUS CHECK (STATUS IN ('ACTIVE', 'INACTIVE'))
);

CREATE INDEX IDX_ROLE_NAME   ON devuser.ROLE (NAME);
CREATE INDEX IDX_ROLE_STATUS ON devuser.ROLE (STATUS);

CREATE SEQUENCE devuser.SEQ_ROLE_HIS START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.ROLE_HIS (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_ROLE_HIS'),
    ORIGINAL_ID     BIGINT          NOT NULL,
    NAME            VARCHAR(100)    NOT NULL,
    DESCRIPTION     VARCHAR(500),
    STATUS          VARCHAR(20)     NOT NULL,
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    DML_OPERATION   VARCHAR(10),
    DML_BY          VARCHAR(100),
    DML_DATE        TIMESTAMP,
    DML_IP          VARCHAR(45),
    CONSTRAINT PK_ROLE_HIS PRIMARY KEY (ID)
);

CREATE INDEX IDX_ROLE_HIS_ORIGINAL_ID ON devuser.ROLE_HIS (ORIGINAL_ID);

CREATE OR REPLACE FUNCTION devuser.FN_ROLE_HIS()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO devuser.ROLE_HIS (
            ID, ORIGINAL_ID, NAME, DESCRIPTION, STATUS,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_ROLE_HIS'), NEW.ID, NEW.NAME, NEW.DESCRIPTION, NEW.STATUS,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'INSERT', NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO devuser.ROLE_HIS (
            ID, ORIGINAL_ID, NAME, DESCRIPTION, STATUS,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_ROLE_HIS'), NEW.ID, NEW.NAME, NEW.DESCRIPTION, NEW.STATUS,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'UPDATE', NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        INSERT INTO devuser.ROLE_HIS (
            ID, ORIGINAL_ID, NAME, DESCRIPTION, STATUS,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_ROLE_HIS'), OLD.ID, OLD.NAME, OLD.DESCRIPTION, OLD.STATUS,
            OLD.CREATED_BY, OLD.CREATED_DATE, OLD.CREATED_IP, OLD.UPDATED_BY, OLD.UPDATED_DATE, OLD.UPDATED_IP,
            'DELETE', COALESCE(OLD.UPDATED_BY, OLD.CREATED_BY), COALESCE(OLD.UPDATED_DATE, OLD.CREATED_DATE), COALESCE(OLD.UPDATED_IP, OLD.CREATED_IP)
        );
        RETURN OLD;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER TRG_ROLE_HIS
    AFTER INSERT OR UPDATE OR DELETE ON devuser.ROLE
    FOR EACH ROW EXECUTE FUNCTION devuser.FN_ROLE_HIS();


-- ---------------------------------------------------------------
-- PERMISSION
-- ---------------------------------------------------------------
CREATE SEQUENCE devuser.SEQ_PERMISSION START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.PERMISSION (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_PERMISSION'),
    NAME            VARCHAR(100)    NOT NULL,
    DESCRIPTION     VARCHAR(500),
    MODULE          VARCHAR(100)    NOT NULL,
    ACTION          VARCHAR(50)     NOT NULL,
    STATUS          VARCHAR(20)     NOT NULL DEFAULT 'ACTIVE',
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    CONSTRAINT PK_PERMISSION                PRIMARY KEY (ID),
    CONSTRAINT UK_PERMISSION_NAME           UNIQUE (NAME),
    CONSTRAINT UK_PERMISSION_MODULE_ACTION  UNIQUE (MODULE, ACTION),
    CONSTRAINT CK_PERMISSION_STATUS         CHECK (STATUS IN ('ACTIVE', 'INACTIVE')),
    CONSTRAINT CK_PERMISSION_ACTION         CHECK (ACTION IN ('CREATE', 'READ', 'UPDATE', 'DELETE', 'LIST', 'EXPORT', 'IMPORT'))
);

CREATE INDEX IDX_PERMISSION_NAME   ON devuser.PERMISSION (NAME);
CREATE INDEX IDX_PERMISSION_MODULE ON devuser.PERMISSION (MODULE);
CREATE INDEX IDX_PERMISSION_ACTION ON devuser.PERMISSION (ACTION);
CREATE INDEX IDX_PERMISSION_STATUS ON devuser.PERMISSION (STATUS);

CREATE SEQUENCE devuser.SEQ_PERMISSION_HIS START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.PERMISSION_HIS (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_PERMISSION_HIS'),
    ORIGINAL_ID     BIGINT          NOT NULL,
    NAME            VARCHAR(100)    NOT NULL,
    DESCRIPTION     VARCHAR(500),
    MODULE          VARCHAR(100)    NOT NULL,
    ACTION          VARCHAR(50)     NOT NULL,
    STATUS          VARCHAR(20)     NOT NULL,
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    DML_OPERATION   VARCHAR(10),
    DML_BY          VARCHAR(100),
    DML_DATE        TIMESTAMP,
    DML_IP          VARCHAR(45),
    CONSTRAINT PK_PERMISSION_HIS PRIMARY KEY (ID)
);

CREATE INDEX IDX_PERMISSION_HIS_ORIGINAL_ID ON devuser.PERMISSION_HIS (ORIGINAL_ID);

CREATE OR REPLACE FUNCTION devuser.FN_PERMISSION_HIS()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO devuser.PERMISSION_HIS (
            ID, ORIGINAL_ID, NAME, DESCRIPTION, MODULE, ACTION, STATUS,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_PERMISSION_HIS'), NEW.ID, NEW.NAME, NEW.DESCRIPTION, NEW.MODULE, NEW.ACTION, NEW.STATUS,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'INSERT', NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO devuser.PERMISSION_HIS (
            ID, ORIGINAL_ID, NAME, DESCRIPTION, MODULE, ACTION, STATUS,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_PERMISSION_HIS'), NEW.ID, NEW.NAME, NEW.DESCRIPTION, NEW.MODULE, NEW.ACTION, NEW.STATUS,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'UPDATE', NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        INSERT INTO devuser.PERMISSION_HIS (
            ID, ORIGINAL_ID, NAME, DESCRIPTION, MODULE, ACTION, STATUS,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_PERMISSION_HIS'), OLD.ID, OLD.NAME, OLD.DESCRIPTION, OLD.MODULE, OLD.ACTION, OLD.STATUS,
            OLD.CREATED_BY, OLD.CREATED_DATE, OLD.CREATED_IP, OLD.UPDATED_BY, OLD.UPDATED_DATE, OLD.UPDATED_IP,
            'DELETE', COALESCE(OLD.UPDATED_BY, OLD.CREATED_BY), COALESCE(OLD.UPDATED_DATE, OLD.CREATED_DATE), COALESCE(OLD.UPDATED_IP, OLD.CREATED_IP)
        );
        RETURN OLD;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER TRG_PERMISSION_HIS
    AFTER INSERT OR UPDATE OR DELETE ON devuser.PERMISSION
    FOR EACH ROW EXECUTE FUNCTION devuser.FN_PERMISSION_HIS();


-- ---------------------------------------------------------------
-- USERS_ROLE
-- ---------------------------------------------------------------
CREATE SEQUENCE devuser.SEQ_USERS_ROLE START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.USERS_ROLE (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_USERS_ROLE'),
    USERS_ID        BIGINT          NOT NULL,
    ROLE_ID         BIGINT          NOT NULL,
    ASSIGNED_BY     VARCHAR(100)    NOT NULL,
    ASSIGNED_DATE   TIMESTAMP       NOT NULL,
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    CONSTRAINT PK_USERS_ROLE             PRIMARY KEY (ID),
    CONSTRAINT UK_USERS_ROLE_USERS_ROLE  UNIQUE (USERS_ID, ROLE_ID),
    CONSTRAINT FK_USERS_ROLE_USERS       FOREIGN KEY (USERS_ID) REFERENCES devuser.USERS(ID),
    CONSTRAINT FK_USERS_ROLE_ROLE        FOREIGN KEY (ROLE_ID)  REFERENCES devuser.ROLE(ID)
);

CREATE INDEX IDX_USERS_ROLE_USERS_ID ON devuser.USERS_ROLE (USERS_ID);
CREATE INDEX IDX_USERS_ROLE_ROLE_ID  ON devuser.USERS_ROLE (ROLE_ID);

CREATE SEQUENCE devuser.SEQ_USERS_ROLE_HIS START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.USERS_ROLE_HIS (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_USERS_ROLE_HIS'),
    ORIGINAL_ID     BIGINT          NOT NULL,
    USERS_ID        BIGINT          NOT NULL,
    ROLE_ID         BIGINT          NOT NULL,
    ASSIGNED_BY     VARCHAR(100)    NOT NULL,
    ASSIGNED_DATE   TIMESTAMP       NOT NULL,
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    DML_OPERATION   VARCHAR(10),
    DML_BY          VARCHAR(100),
    DML_DATE        TIMESTAMP,
    DML_IP          VARCHAR(45),
    CONSTRAINT PK_USERS_ROLE_HIS PRIMARY KEY (ID)
);

CREATE INDEX IDX_USERS_ROLE_HIS_ORIGINAL_ID ON devuser.USERS_ROLE_HIS (ORIGINAL_ID);

CREATE OR REPLACE FUNCTION devuser.FN_USERS_ROLE_HIS()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO devuser.USERS_ROLE_HIS (
            ID, ORIGINAL_ID, USERS_ID, ROLE_ID, ASSIGNED_BY, ASSIGNED_DATE,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_USERS_ROLE_HIS'), NEW.ID, NEW.USERS_ID, NEW.ROLE_ID, NEW.ASSIGNED_BY, NEW.ASSIGNED_DATE,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'INSERT', NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO devuser.USERS_ROLE_HIS (
            ID, ORIGINAL_ID, USERS_ID, ROLE_ID, ASSIGNED_BY, ASSIGNED_DATE,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_USERS_ROLE_HIS'), NEW.ID, NEW.USERS_ID, NEW.ROLE_ID, NEW.ASSIGNED_BY, NEW.ASSIGNED_DATE,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'UPDATE', NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        INSERT INTO devuser.USERS_ROLE_HIS (
            ID, ORIGINAL_ID, USERS_ID, ROLE_ID, ASSIGNED_BY, ASSIGNED_DATE,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_USERS_ROLE_HIS'), OLD.ID, OLD.USERS_ID, OLD.ROLE_ID, OLD.ASSIGNED_BY, OLD.ASSIGNED_DATE,
            OLD.CREATED_BY, OLD.CREATED_DATE, OLD.CREATED_IP, OLD.UPDATED_BY, OLD.UPDATED_DATE, OLD.UPDATED_IP,
            'DELETE', COALESCE(OLD.UPDATED_BY, OLD.CREATED_BY), COALESCE(OLD.UPDATED_DATE, OLD.CREATED_DATE), COALESCE(OLD.UPDATED_IP, OLD.CREATED_IP)
        );
        RETURN OLD;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER TRG_USERS_ROLE_HIS
    AFTER INSERT OR UPDATE OR DELETE ON devuser.USERS_ROLE
    FOR EACH ROW EXECUTE FUNCTION devuser.FN_USERS_ROLE_HIS();


-- ---------------------------------------------------------------
-- ROLE_PERMISSION
-- ---------------------------------------------------------------
CREATE SEQUENCE devuser.SEQ_ROLE_PERMISSION START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.ROLE_PERMISSION (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_ROLE_PERMISSION'),
    ROLE_ID         BIGINT          NOT NULL,
    PERMISSION_ID   BIGINT          NOT NULL,
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    CONSTRAINT PK_ROLE_PERMISSION                       PRIMARY KEY (ID),
    CONSTRAINT UK_ROLE_PERMISSION_ROLE_PERMISSION       UNIQUE (ROLE_ID, PERMISSION_ID),
    CONSTRAINT FK_ROLE_PERMISSION_ROLE                  FOREIGN KEY (ROLE_ID)       REFERENCES devuser.ROLE(ID),
    CONSTRAINT FK_ROLE_PERMISSION_PERMISSION            FOREIGN KEY (PERMISSION_ID) REFERENCES devuser.PERMISSION(ID)
);

CREATE INDEX IDX_ROLE_PERMISSION_ROLE_ID       ON devuser.ROLE_PERMISSION (ROLE_ID);
CREATE INDEX IDX_ROLE_PERMISSION_PERMISSION_ID ON devuser.ROLE_PERMISSION (PERMISSION_ID);

CREATE SEQUENCE devuser.SEQ_ROLE_PERMISSION_HIS START WITH 1 INCREMENT BY 1;

CREATE TABLE devuser.ROLE_PERMISSION_HIS (
    ID              BIGINT          NOT NULL DEFAULT nextval('devuser.SEQ_ROLE_PERMISSION_HIS'),
    ORIGINAL_ID     BIGINT          NOT NULL,
    ROLE_ID         BIGINT          NOT NULL,
    PERMISSION_ID   BIGINT          NOT NULL,
    CREATED_BY      VARCHAR(100)    NOT NULL,
    CREATED_DATE    TIMESTAMP       NOT NULL,
    CREATED_IP      VARCHAR(45)     NOT NULL,
    UPDATED_BY      VARCHAR(100),
    UPDATED_DATE    TIMESTAMP,
    UPDATED_IP      VARCHAR(45),
    DML_OPERATION   VARCHAR(10),
    DML_BY          VARCHAR(100),
    DML_DATE        TIMESTAMP,
    DML_IP          VARCHAR(45),
    CONSTRAINT PK_ROLE_PERMISSION_HIS PRIMARY KEY (ID)
);

CREATE INDEX IDX_ROLE_PERMISSION_HIS_ORIGINAL_ID ON devuser.ROLE_PERMISSION_HIS (ORIGINAL_ID);

CREATE OR REPLACE FUNCTION devuser.FN_ROLE_PERMISSION_HIS()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO devuser.ROLE_PERMISSION_HIS (
            ID, ORIGINAL_ID, ROLE_ID, PERMISSION_ID,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_ROLE_PERMISSION_HIS'), NEW.ID, NEW.ROLE_ID, NEW.PERMISSION_ID,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'INSERT', NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO devuser.ROLE_PERMISSION_HIS (
            ID, ORIGINAL_ID, ROLE_ID, PERMISSION_ID,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_ROLE_PERMISSION_HIS'), NEW.ID, NEW.ROLE_ID, NEW.PERMISSION_ID,
            NEW.CREATED_BY, NEW.CREATED_DATE, NEW.CREATED_IP, NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP,
            'UPDATE', NEW.UPDATED_BY, NEW.UPDATED_DATE, NEW.UPDATED_IP
        );
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        INSERT INTO devuser.ROLE_PERMISSION_HIS (
            ID, ORIGINAL_ID, ROLE_ID, PERMISSION_ID,
            CREATED_BY, CREATED_DATE, CREATED_IP, UPDATED_BY, UPDATED_DATE, UPDATED_IP,
            DML_OPERATION, DML_BY, DML_DATE, DML_IP
        ) VALUES (
            nextval('devuser.SEQ_ROLE_PERMISSION_HIS'), OLD.ID, OLD.ROLE_ID, OLD.PERMISSION_ID,
            OLD.CREATED_BY, OLD.CREATED_DATE, OLD.CREATED_IP, OLD.UPDATED_BY, OLD.UPDATED_DATE, OLD.UPDATED_IP,
            'DELETE', COALESCE(OLD.UPDATED_BY, OLD.CREATED_BY), COALESCE(OLD.UPDATED_DATE, OLD.CREATED_DATE), COALESCE(OLD.UPDATED_IP, OLD.CREATED_IP)
        );
        RETURN OLD;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER TRG_ROLE_PERMISSION_HIS
    AFTER INSERT OR UPDATE OR DELETE ON devuser.ROLE_PERMISSION
    FOR EACH ROW EXECUTE FUNCTION devuser.FN_ROLE_PERMISSION_HIS();